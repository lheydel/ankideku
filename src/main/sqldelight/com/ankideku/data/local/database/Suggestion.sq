-- Suggestions generated by LLM for note improvements
-- Field data (original_fields, changes, edited_changes) stored in field_value table

CREATE TABLE suggestion (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id INTEGER NOT NULL REFERENCES session(id) ON DELETE CASCADE,
    note_id INTEGER NOT NULL,
    reasoning TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'pending',  -- pending, accepted, rejected, skipped
    created_at INTEGER NOT NULL,
    decided_at INTEGER
);

CREATE INDEX idx_suggestion_session ON suggestion(session_id);
CREATE INDEX idx_suggestion_status ON suggestion(session_id, status);
CREATE INDEX idx_suggestion_note ON suggestion(note_id);
CREATE UNIQUE INDEX idx_suggestion_session_note ON suggestion(session_id, note_id);

-- Suggestion queries

getSuggestionsForSession:
SELECT * FROM suggestion WHERE session_id = ? ORDER BY id;

getPendingSuggestionsForSession:
SELECT * FROM suggestion WHERE session_id = ? AND status = 'pending' ORDER BY id;

getSuggestionById:
SELECT * FROM suggestion WHERE id = ?;

insertSuggestion:
INSERT INTO suggestion (session_id, note_id, reasoning, status, created_at)
VALUES (?, ?, ?, ?, ?);

lastInsertedSuggestionId:
SELECT last_insert_rowid();

updateSuggestionStatus:
UPDATE suggestion SET status = ?, decided_at = ? WHERE id = ?;

touchSuggestion:
UPDATE suggestion SET id = id WHERE id = ?;

deleteSuggestion:
DELETE FROM suggestion WHERE id = ?;
